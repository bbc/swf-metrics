#!/usr/bin/env node

const api = require('..');
const Table = require('cli-table');
const consolidate = require('../lib/activity/consolidate.js');

api
  .getFailedWorkflowsActivities({ domain: 'ExampleFreebird' })
  .then(data => consolidate(data))
  .then(data => {
    const grandTotal = Object.keys(data).reduce((count, key) => {
      return count + data[key].filter(d => d.status === "Failed").length;
    }, 0);

    const t = new Table({
      head: ['Activity', '#', '# errors', '% errors'],
    });

    Object.keys(data).forEach(key => {
      const d = data[key];
      const failed = d.filter(d => d.status === "Failed");

      t.push([
        key,
        d.length,
        failed.length,
        (failed.length / grandTotal * 100).toFixed(2),
      ]);
    });

    console.log(t.toString());
  })
  .catch(err => console.error(err));
